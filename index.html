<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<title>DD KPI Tracker</title>

<style>
:root { --pad:12px; --r:14px; --shadow:0 6px 18px rgba(0,0,0,.08); }
*{box-sizing:border-box;}
body{
  font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  margin:0;background:#f6f7fb;color:#111;
}

/* ===== Header ===== */
.appHeader{
  position:sticky;top:0;z-index:20;
  background:#fff;box-shadow:var(--shadow);
  padding:calc(8px + env(safe-area-inset-top)) var(--pad) 10px;
}
.headerTop{
  display:grid;grid-template-columns:44px 1fr 44px;align-items:center;gap:10px;
}
.titleWrap{min-width:0;}
.title{font-weight:900;font-size:15px;line-height:1.1;}
.subtitle{font-size:11px;opacity:.65;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

.iconBtn{
  width:44px;height:44px;border-radius:14px;
  border:1px solid #e6e9f2;background:#fff;
  font-size:18px;font-weight:900;color:#111;
}
.iconBtn:active{transform:translateY(1px);}
.iconBtn.menu{
  background:#111;color:#fff;border:0;
  display:flex;align-items:center;justify-content:center;
}

/* Menu */
.headerPanel{display:none;margin-top:10px;padding-top:10px;border-top:1px solid #edf0f7;}
.headerPanel.open{display:block;}
.panelGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:560px){.panelGrid{grid-template-columns:1fr;}}
.menuActions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
@media(max-width:560px){.menuActions{grid-template-columns:1fr;}}

/* small menu buttons */
.menuBtn{
  width:100%;
  border-radius:12px;
  padding:10px 10px;
  font-size:14px;
  font-weight:900;
  border:1px solid #dfe3ee;
  background:#fff;color:#111;
  box-shadow:none;
}
.menuBtn.primary{
  background:#111;color:#fff;border:0;box-shadow:var(--shadow);
}
.menuBtn.danger{
  background:#d11;color:#fff;border:0;box-shadow:var(--shadow);
}

/* menu form (2 columns; collapses to 1 on small screens) */
.menuForm{
  margin-top:10px;
  padding-top:10px;
  border-top:1px solid #edf0f7;
}
.menuRow2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  align-items:end;
}
.menuRow2 label{font-size:12px;opacity:.75;display:block;margin-bottom:6px;}
.menuRow2 input,.menuRow2 select{
  width:100%;
  border-radius:10px;
  border:1px solid #dfe3ee;
  padding:8px 10px;
  font-size:16px;
  background:#fff;
}
@media(max-width:420px){
  .menuRow2{ grid-template-columns: 1fr; }
}

/* Layout */
main{padding:var(--pad);max-width:1040px;margin:0 auto;}
.grid{display:grid;gap:var(--pad);}
@media(min-width:920px){.grid{grid-template-columns:1.1fr .9fr;}}

.card{background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:var(--pad);}

.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
@media(max-width:560px){
  .row3{grid-template-columns:1fr 1fr;}
  .row3>div:last-child{grid-column:1/-1;}
}

/* Buttons (main) */
button{
  width:100%;border:0;border-radius:14px;padding:16px 12px;
  font-size:16px;font-weight:900;
  box-shadow:var(--shadow);background:#111;color:#fff;
}
button.secondary{background:#fff;color:#111;border:1px solid #dfe3ee;box-shadow:none;}
button:active{transform:translateY(1px);}

.hr{height:1px;background:#edf0f7;margin:12px 0;}
.small{font-size:12px;opacity:.78;}
.muted{opacity:.7;}
.mono{font-variant-numeric:tabular-nums;}
.chip{padding:3px 8px;border:1px solid #dfe3ee;border-radius:999px;font-size:12px;font-weight:900;background:#fff;}

/* KPI Cards */
.statGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.stat{background:#f6f7fb;border:1px solid #e6e9f2;border-radius:14px;padding:10px 12px;}
.stat .k{font-size:12px;opacity:.75;}
.stat .v{font-size:22px;font-weight:900;margin-top:2px;}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;margin-top:6px;}
.ok{background:#e7f7ea;color:#116b2a;}
.mid{background:#fff6dd;color:#7a4d00;}
.bad{background:#ffe5e5;color:#8a0f0f;}
.targetHint{font-size:11px;opacity:.65;margin-top:6px;}

/* Tables */
.tableWrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px 6px;border-bottom:1px solid #edf0f7;font-size:13px;text-align:left;}
th{opacity:.7;font-weight:900;}
.totalRow td{background:#f6f7fb;font-weight:900;}
.kpiCell{display:flex;align-items:center;gap:6px;}
.dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.08);}
.dot.ok{background:#2dbf4f;}
.dot.mid{background:#f0b429;}
.dot.bad{background:#e03b3b;}
.scoreInput{
  width:72px;
  padding:6px 8px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #dfe3ee;
}
@media(max-width:420px){ .scoreInput{width:64px;} }

/* Modal */
.modalWrap{
  position: fixed; inset:0; display:none;
  align-items:center; justify-content:center;
  padding: 16px; background: rgba(0,0,0,.35); z-index: 50;
}
.modal{
  width: min(680px, 100%);
  background:#fff; border-radius: 18px; box-shadow: var(--shadow);
  padding: 14px;
}
.modal h2{ margin: 4px 0 10px; font-size: 16px; }
.modal .row3{grid-template-columns:1fr 1fr 1fr;}
@media(max-width:560px){ .modal .row3{grid-template-columns:1fr;} }
label{font-size:12px;opacity:.75;display:block;margin-bottom:6px;}
input[type="text"]{
  width:100%; border-radius:12px; border:1px solid #dfe3ee;
  padding:10px 12px; font-size:16px; background:#fff;
}
.right{text-align:right;}
.fileInput{display:none;}

/* Toast */
.toast{
  position:fixed;left:50%;bottom:calc(16px + env(safe-area-inset-bottom));
  transform:translateX(-50%);
  background:rgba(17,17,17,.92);
  color:#fff;padding:10px 12px;border-radius:999px;
  box-shadow:var(--shadow);
  font-size:13px;opacity:0;transition:.2s;
  max-width:min(92vw,620px);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  pointer-events:none;
  z-index:99;
}
.toast.show{opacity:1;}
</style>
</head>

<body>
<header class="appHeader">
  <div class="headerTop">
    <button class="iconBtn menu" id="btnMenu" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" type="button">â˜°</button>

    <div class="titleWrap">
      <div class="title">DD KPI Trackerï¼ˆä¿Šä»‹ï¼‰</div>
      <div class="subtitle">Halfæœ€é‡è¦ã€‚Qåˆ¥ï¼‹åˆè¨ˆã€‚å¾—ç‚¹ç›¸é–¢ã‚‚è¦‹ã‚‹ã€‚</div>
    </div>

    <button class="iconBtn" id="btnQuickSave" aria-label="ä¿å­˜" type="button">ğŸ’¾</button>
  </div>

  <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†… -->
  <div class="headerPanel" id="headerPanel">
    <div class="panelGrid">
      <div>
        <label>è©¦åˆã‚’é¸æŠï¼ˆéå»ï¼‰</label>
        <select id="gameSelect"></select>
      </div>
      <div>
        <label>ç›®æ¨™ï¼ˆãƒã‚¹ã‚¿ï¼‰</label>
        <button class="menuBtn" id="btnTargets" type="button">KPIç›®æ¨™ã‚’ç·¨é›†</button>
      </div>
    </div>

    <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆ2åˆ—ï¼‰ -->
    <div class="menuForm">
      <div class="menuRow2">
        <div>
          <label>ç›¸æ‰‹ãƒãƒ¼ãƒ </label>
          <input id="opponent" type="text" placeholder="ä¾‹ï¼šINUYAMA" />
        </div>
        <div>
          <label>æ—¥ä»˜</label>
          <input id="gameDate" type="date" />
        </div>
      </div>

      <div class="menuRow2" style="margin-top:10px;">
        <div>
          <label>ç¾åœ¨ã®Q</label>
          <select id="quarter"></select>
        </div>
        <div>
          <label>ãƒ¡ãƒ¢</label>
          <input id="memo" type="text" placeholder="ä¾‹ï¼šãƒ—ãƒ¬ã‚¹å¼·ã‚" />
        </div>
      </div>

      <div class="small muted" style="margin-top:8px;">
        Half Paint Rate = <span class="chip">HP/H</span>ã€€
        Early Paint Rate = <span class="chip">TP/T</span>ã€€
        Foul Rate = <span class="chip">F/(HP+TP)</span>
      </div>
    </div>

    <div class="menuActions">
      <button class="menuBtn primary" id="btnNewGame" type="button">æ–°ã—ã„è©¦åˆ</button>
      <button class="menuBtn" id="btnExportFile" type="button">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="menuBtn" id="btnImport" type="button">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="menuBtn danger" id="btnDeleteGame" type="button">ã“ã®è©¦åˆå‰Šé™¤</button>
    </div>

    <input class="fileInput" id="fileInput" type="file" accept="application/json" />
  </div>
</header>

<main>
  <div class="grid">
    <!-- Left: counters -->
    <section class="card">
      <div class="row3">
        <div><label>Halfé–¢ä¸ï¼ˆHï¼‰</label><button id="btnH" type="button">+1</button></div>
        <div><label>Half Paintï¼ˆHPï¼‰</label><button id="btnB" type="button">+1</button></div>
        <div><label>Foulï¼ˆFï¼‰</label><button id="btnD" type="button">+1</button></div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div><label>Transé–¢ä¸ï¼ˆTï¼‰</label><button id="btnT" type="button">+1</button></div>
        <div><label>TransPaintï¼ˆTPï¼‰</label><button id="btnTP" type="button">+1</button></div>
        <div><label>Undo</label><button class="secondary" id="btnUndo" type="button">1ã¤æˆ»ã™</button></div>
      </div>

      <div class="hr"></div>
      <div class="small">
        <b>æ“ä½œãƒ«ãƒ¼ãƒ«ï¼š</b>é€Ÿæ”»ã§ä¸­ã«è§¦ã£ãŸã‚‰ <span class="chip">T</span> ã¨ <span class="chip">TP</span> ã‚’ä¸¡æ–¹ +1ã€‚<br/>
        Halfä¾µå…¥ã¯ <span class="chip">H</span> ã‚’ +1ã€ãƒšã‚¤ãƒ³ãƒˆã¾ã§å…¥ã£ãŸã‚‰ <span class="chip">HP</span> ã‚‚ +1ã€‚
      </div>
    </section>

    <!-- Right: KPIs + tables -->
    <aside class="card">
      <div class="statGrid">
        <div class="stat">
          <div class="k">Half Paint Rateï¼ˆåˆè¨ˆãƒ»æœ€é‡è¦ï¼‰</div>
          <div class="v mono" id="kHalf">0%</div>
          <div class="pill" id="sHalf">-</div>
          <div class="targetHint" id="tHalf"></div>
        </div>

        <div class="stat">
          <div class="k">Early Paint Rateï¼ˆåˆè¨ˆï¼‰</div>
          <div class="v mono" id="kEarly">0%</div>
          <div class="pill" id="sEarly">-</div>
          <div class="targetHint" id="tEarly"></div>
        </div>

        <div class="stat">
          <div class="k">Paint Rateï¼ˆåˆè¨ˆï¼‰</div>
          <div class="v mono" id="kPaint">0%</div>
          <div class="pill" id="sPaint">-</div>
          <div class="targetHint" id="tPaint"></div>
        </div>

        <div class="stat">
          <div class="k">Foul Rateï¼ˆåˆè¨ˆï¼‰</div>
          <div class="v mono" id="kFoul">0%</div>
          <div class="pill" id="sFoul">-</div>
          <div class="targetHint" id="tFoul"></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>Q</th><th>H</th><th>HP</th><th>F</th><th>T</th><th>TP</th></tr>
          </thead>
          <tbody id="qTable"></tbody>
        </table>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Q</th>
              <th>Half</th>
              <th>Early</th>
              <th>Paint</th>
              <th>Foul</th>
            </tr>
          </thead>
          <tbody id="kpiTable"></tbody>
        </table>
      </div>

      <div class="hr"></div>

      <div style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;">
        <div style="font-weight:900;">å¾—ç‚¹ï¼ˆQåˆ¥ï¼‰</div>
        <div class="small muted">ç›¸é–¢ï¼šPaint Rate Ã— è‡ªãƒãƒ¼ãƒ å¾—ç‚¹</div>
      </div>

      <div class="tableWrap" style="margin-top:6px;">
        <table>
          <thead>
            <tr><th>Q</th><th>è‡ª</th><th>ç›¸æ‰‹</th><th>Paint</th></tr>
          </thead>
          <tbody id="scoreTable"></tbody>
        </table>
      </div>

      <div class="small" style="margin-top:8px;">
        <b>ç›¸é–¢ rï¼š</b><span class="mono" id="corrVal">-</span>
        <span class="muted" id="corrNote"></span>
      </div>

      <div class="hr"></div>
      <div class="small muted">
        ä¿å­˜ï¼šç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ï¼‹JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‚<br/>
        â€» iOSã¯ãƒ•ã‚©ãƒ«ãƒ€è‡ªå‹•ä¿å­˜ä¸å¯ï¼ˆå…±æœ‰ã‚·ãƒ¼ãƒˆã§é¸æŠï¼‰
      </div>
    </aside>
  </div>
</main>

<!-- Targets Modal -->
<div class="modalWrap" id="targetsModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="targetsTitle">
    <h2 id="targetsTitle">KPIç›®æ¨™ï¼ˆãƒã‚¹ã‚¿ï¼‰è¨­å®š</h2>
    <div class="small muted">0ã€œ1ã§å…¥åŠ›ã€‚ã€Œé”æˆã€=OKä»¥ä¸Šã€ã€Œæƒœã—ã„ã€=MIDä»¥ä¸Š</div>

    <div class="hr"></div>

    <div class="row3">
      <div><label>Half Paint OK</label><input id="tgHalfOk" type="text" /></div>
      <div><label>Half Paint MID</label><input id="tgHalfMid" type="text" /></div>
      <div class="small muted" style="display:flex;align-items:end;">ä¾‹ï¼šOK=0.55 / MID=0.50</div>
    </div>

    <div class="row3" style="margin-top:10px;">
      <div><label>Early OK</label><input id="tgEarlyOk" type="text" /></div>
      <div><label>Early MID</label><input id="tgEarlyMid" type="text" /></div>
      <div class="small muted" style="display:flex;align-items:end;">ä¾‹ï¼šOK=0.80 / MID=0.65</div>
    </div>

    <div class="row3" style="margin-top:10px;">
      <div><label>Paint OK</label><input id="tgPaintOk" type="text" /></div>
      <div><label>Paint MID</label><input id="tgPaintMid" type="text" /></div>
      <div class="small muted" style="display:flex;align-items:end;">ä¾‹ï¼šOK=0.60 / MID=0.50</div>
    </div>

    <div class="row3" style="margin-top:10px;">
      <div><label>Foul OK</label><input id="tgFoulOk" type="text" /></div>
      <div><label>Foul MID</label><input id="tgFoulMid" type="text" /></div>
      <div class="small muted" style="display:flex;align-items:end;">ä¾‹ï¼šOK=0.25 / MID=0.18</div>
    </div>

    <div class="hr"></div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <button class="secondary" id="btnTargetsDefault" type="button">åˆæœŸå€¤ã«æˆ»ã™</button>
      <div class="right">
        <button class="secondary" id="btnTargetsCancel" type="button" style="width:auto;padding:12px 14px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="btnTargetsSave" type="button" style="width:auto;padding:12px 14px;margin-left:8px;">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
// =====================
// Storage keys
// =====================
const STORAGE_GAMES = "dd_kpi_games_v9";
const STORAGE_TARGETS = "dd_kpi_targets_v9";

// =====================
// Q / keys (è¡¨ç¤ºã¯HP/Fã ãŒå†…éƒ¨ã¯B/Dã®ã¾ã¾ï¼äº’æ›ç¶­æŒ)
// =====================
const QS = ["1","2","3","4"];
const KEYS = ["H","B","D","T","TP"]; // H=Half involvement, B=HalfPaint(=HP), D=Foul(=F), T=Trans involvement, TP=Trans paint
const $ = (id) => document.getElementById(id);

// =====================
// Toast
// =====================
let toastTimer = null;
function toast(msg){
  const el = $("toast");
  if (!el) return;
  el.textContent = msg;
  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove("show"), 1400);
}

// =====================
// Targets master
// =====================
const defaultTargets = () => ({
  half:  { ok: 0.55, mid: 0.50 }, // B/H
  early: { ok: 0.80, mid: 0.65 }, // TP/T
  paint: { ok: 0.60, mid: 0.50 }, // (B+TP)/(H+T)
  foul:  { ok: 0.25, mid: 0.18 }, // D/(B+TP)
});

function loadTargets(){
  try {
    const t = JSON.parse(localStorage.getItem(STORAGE_TARGETS));
    return t || defaultTargets();
  } catch { return defaultTargets(); }
}
function saveTargets(t){ localStorage.setItem(STORAGE_TARGETS, JSON.stringify(t)); }
let targets = loadTargets();

// =====================
// Games model
// =====================
function blankGame(){
  const q = {};
  const scores = {};
  QS.forEach(k=>{
    q[k] = {H:0,B:0,D:0,T:0,TP:0};
    scores[k] = {us:null, them:null};
  });
  return {
    id: String(Date.now()),
    opponent: "",
    date: new Date().toISOString().slice(0,10),
    memo: "",
    createdAt: new Date().toISOString(),
    q,
    scores
  };
}

function loadGames(){
  try { return JSON.parse(localStorage.getItem(STORAGE_GAMES) || "[]"); }
  catch { return []; }
}
function saveGames(list){
  localStorage.setItem(STORAGE_GAMES, JSON.stringify(list));
}

function ensureKeys(game){
  if(!game.q) game.q = {};
  if(!game.scores) game.scores = {};
  QS.forEach(qq=>{
    if(!game.q[qq]) game.q[qq] = {H:0,B:0,D:0,T:0,TP:0};
    if(!game.scores[qq]) game.scores[qq] = {us:null, them:null};

    // migration: older keys A/C/E etc. ignored; ensure required keys exist
    KEYS.forEach(k=>{
      if(game.q[qq][k] == null) game.q[qq][k] = 0;
    });

    if(game.scores[qq].us === undefined) game.scores[qq].us = null;
    if(game.scores[qq].them === undefined) game.scores[qq].them = null;
  });
}

// =====================
// State
// =====================
let games = loadGames();
let state = games[0] || blankGame();
ensureKeys(state);
let history = []; // undo {q,key}

// =====================
// Helpers
// =====================
const pct = (x) => (isFinite(x) ? Math.round(x*100) : 0) + "%";
const safeNum01 = (v, fallback) => {
  const n = Number(String(v).trim());
  return Number.isFinite(n) ? n : fallback;
};

function gradeClass(val, tg){
  if (val >= tg.ok) return "ok";
  if (val >= tg.mid) return "mid";
  return "bad";
}
function setBadge(el, val, tg){
  el.classList.remove("ok","mid","bad");
  const cls = gradeClass(val, tg);
  el.classList.add(cls);
  el.textContent = cls==="ok" ? "é”æˆ" : (cls==="mid" ? "æƒœã—ã„" : "æœªé”");
}
function setTargetHint(el, tg){
  el.textContent = `ç›®æ¨™ OKâ‰¥${Math.round(tg.ok*100)}% / æƒœã—ã„â‰¥${Math.round(tg.mid*100)}%`;
}

function sumKey(key){
  return QS.reduce((s,qq)=> s + (state.q[qq]?.[key] || 0), 0);
}
function getCountsForQuarter(q){
  return { ...(state.q[q] || {H:0,B:0,D:0,T:0,TP:0}) };
}
function getCountsTotal(){
  const out = {H:0,B:0,D:0,T:0,TP:0};
  KEYS.forEach(k => out[k] = sumKey(k));
  return out;
}

function computeKPIFromCounts(c){
  const H = c.H||0, B=c.B||0, D=c.D||0, T=c.T||0, TP=c.TP||0;
  const half = H ? (B/H) : 0;
  const early = T ? (TP/T) : 0;
  const denPaint = (H+T);
  const paint = denPaint ? ((B+TP)/denPaint) : 0;
  const denFoul = (B+TP);
  const foul = denFoul ? (D/denFoul) : 0;
  return {half, early, paint, foul};
}

function pearson(xs, ys){
  const n = Math.min(xs.length, ys.length);
  if (n < 2) return null;
  let sx=0, sy=0;
  for (let i=0;i<n;i++){ sx += xs[i]; sy += ys[i]; }
  const mx = sx/n, my = sy/n;
  let num=0, dx=0, dy=0;
  for (let i=0;i<n;i++){
    const a = xs[i]-mx, b = ys[i]-my;
    num += a*b; dx += a*a; dy += b*b;
  }
  const den = Math.sqrt(dx*dy);
  if (!isFinite(den) || den===0) return null;
  return num/den;
}

// =====================
// Persistence
// =====================
function upsertState(auto=false){
  state.opponent = ($("opponent").value || "").trim();
  state.date = $("gameDate").value || state.date;
  state.memo = ($("memo").value || "").trim();

  const list = loadGames();
  const idx = list.findIndex(g => g.id === state.id);
  if (idx >= 0) list[idx] = state; else list.unshift(state);
  saveGames(list);
  games = list;

  if (!auto) toast("ä¿å­˜ã—ã¾ã—ãŸï¼ˆç«¯æœ«å†…ï¼‰");
}

function switchGame(id){
  upsertState(true);
  const list = loadGames();
  const found = list.find(g => g.id === id);
  if (!found) return;
  ensureKeys(found);
  state = found;
  history = [];
  render();
  toast("è©¦åˆã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ");
}

function newGame(){
  upsertState(true);
  state = blankGame();
  ensureKeys(state);
  history = [];
  const list = loadGames();
  list.unshift(state);
  saveGames(list);
  games = list;
  $("quarter").value = "1";
  render();
  toast("æ–°ã—ã„è©¦åˆã‚’ä½œæˆ");
}

function deleteCurrentGame(){
  if (!confirm("ã“ã®è©¦åˆã®è¨˜éŒ²ã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  const list = loadGames().filter(g => g.id !== state.id);
  saveGames(list);
  games = list;
  state = list[0] || blankGame();
  ensureKeys(state);
  history = [];
  render();
  toast("ã“ã®è©¦åˆã‚’æ¶ˆå»ã—ã¾ã—ãŸ");
}

// =====================
// Counters
// =====================
function inc(key){
  const q = $("quarter").value;
  state.q[q][key] += 1;
  history.push({q,key});
  render();
  upsertState(true);
}
function undo(){
  const last = history.pop();
  if (!last) return toast("æˆ»ã™å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“");
  const {q,key} = last;
  state.q[q][key] = Math.max(0, state.q[q][key] - 1);
  render();
  upsertState(true);
  toast("1ã¤æˆ»ã—ã¾ã—ãŸ");
}

// =====================
// Export / Import
// =====================
function filenameForGame(g){
  const safeName = (g.opponent || "game").replace(/[\\\/:*?"<>|]/g, "_").slice(0,60);
  const d = g.date || new Date().toISOString().slice(0,10);
  return `DDKPI_${d}_${safeName}.json`;
}
function exportAsFile(){
  upsertState(true);
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filenameForGame(state);
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
  toast("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸ");
}
function importFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const g = JSON.parse(reader.result);
      if (!g || !g.id || !g.q) throw new Error("invalid");
      ensureKeys(g);
      const list = loadGames();
      const idx = list.findIndex(x => x.id === g.id);
      if (idx >= 0) list[idx] = g; else list.unshift(g);
      saveGames(list);
      games = list;
      state = g;
      history = [];
      render();
      toast("èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
    } catch {
      toast("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONä¸æ­£ï¼‰");
    }
  };
  reader.readAsText(file, "utf-8");
}

// =====================
// Targets modal
// =====================
function openTargets(){
  $("targetsModal").style.display = "flex";
  $("targetsModal").setAttribute("aria-hidden","false");
  $("tgHalfOk").value = targets.half.ok;
  $("tgHalfMid").value = targets.half.mid;
  $("tgEarlyOk").value = targets.early.ok;
  $("tgEarlyMid").value = targets.early.mid;
  $("tgPaintOk").value = targets.paint.ok;
  $("tgPaintMid").value = targets.paint.mid;
  $("tgFoulOk").value = targets.foul.ok;
  $("tgFoulMid").value = targets.foul.mid;
}
function closeTargets(){
  $("targetsModal").style.display = "none";
  $("targetsModal").setAttribute("aria-hidden","true");
}
function saveTargetsFromUI(){
  const next = {
    half:  { ok: safeNum01($("tgHalfOk").value, targets.half.ok),   mid: safeNum01($("tgHalfMid").value, targets.half.mid) },
    early: { ok: safeNum01($("tgEarlyOk").value, targets.early.ok), mid: safeNum01($("tgEarlyMid").value, targets.early.mid) },
    paint: { ok: safeNum01($("tgPaintOk").value, targets.paint.ok), mid: safeNum01($("tgPaintMid").value, targets.paint.mid) },
    foul:  { ok: safeNum01($("tgFoulOk").value, targets.foul.ok),   mid: safeNum01($("tgFoulMid").value, targets.foul.mid) },
  };

  for (const k of Object.keys(next)){
    if (next[k].ok < next[k].mid) return toast(`ã‚¨ãƒ©ãƒ¼ï¼š${k} ã¯ OK < MID ã§ã™`);
    if (next[k].ok < 0 || next[k].ok > 1 || next[k].mid < 0 || next[k].mid > 1) return toast(`ã‚¨ãƒ©ãƒ¼ï¼š${k} ã¯ 0ã€œ1`);
  }

  targets = next;
  saveTargets(targets);
  closeTargets();
  render();
  toast("ç›®æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}
function resetTargetsDefault(){
  targets = defaultTargets();
  saveTargets(targets);
  openTargets();
  render();
  toast("åˆæœŸå€¤ã«æˆ»ã—ã¾ã—ãŸ");
}

// =====================
// Menu toggle
// =====================
function toggleMenu(force){
  const panel = $("headerPanel");
  const isOpen = panel.classList.contains("open");
  const next = (force==null) ? !isOpen : force;
  panel.classList.toggle("open", next);
}

// =====================
// Rendering
// =====================
function renderQuarterSelect(){
  const sel = $("quarter");
  sel.innerHTML = "";
  QS.forEach(q=>{
    const opt = document.createElement("option");
    opt.value = q;
    opt.textContent = `${q}Q`;
    sel.appendChild(opt);
  });
  if (!sel.value) sel.value = "1";
}

function renderGameSelect(){
  const sel = $("gameSelect");
  sel.innerHTML = "";
  const list = loadGames();
  games = list;
  if (!games.length){
    games = [state];
    saveGames(games);
  }
  games.forEach(g=>{
    const opt = document.createElement("option");
    opt.value = g.id;
    opt.textContent = `${g.date || "----"}  ${g.opponent || "(ç›¸æ‰‹æœªå…¥åŠ›)"}`;
    if (g.id === state.id) opt.selected = true;
    sel.appendChild(opt);
  });
}

function renderTotals(){
  const k = computeKPIFromCounts(getCountsTotal());
  $("kHalf").textContent = pct(k.half);
  $("kEarly").textContent = pct(k.early);
  $("kPaint").textContent = pct(k.paint);
  $("kFoul").textContent = pct(k.foul);

  setBadge($("sHalf"), k.half, targets.half);
  setBadge($("sEarly"), k.early, targets.early);
  setBadge($("sPaint"), k.paint, targets.paint);
  setBadge($("sFoul"), k.foul, targets.foul);

  setTargetHint($("tHalf"), targets.half);
  setTargetHint($("tEarly"), targets.early);
  setTargetHint($("tPaint"), targets.paint);
  setTargetHint($("tFoul"), targets.foul);
}

function renderCountsTable(){
  const tbody = $("qTable");
  tbody.innerHTML = "";

  QS.forEach(qq=>{
    const r = state.q[qq];
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${qq}Q</td>
      <td class="mono">${r.H}</td>
      <td class="mono">${r.B}</td>
      <td class="mono">${r.D}</td>
      <td class="mono">${r.T}</td>
      <td class="mono">${r.TP}</td>`;
    tbody.appendChild(tr);
  });

  const tot = getCountsTotal();
  const trT = document.createElement("tr");
  trT.className = "totalRow";
  trT.innerHTML = `<td>åˆè¨ˆ</td>
    <td class="mono">${tot.H}</td>
    <td class="mono">${tot.B}</td>
    <td class="mono">${tot.D}</td>
    <td class="mono">${tot.T}</td>
    <td class="mono">${tot.TP}</td>`;
  tbody.appendChild(trT);
}

function kpiCell(val, tg){
  const cls = gradeClass(val, tg);
  return `<div class="kpiCell"><span class="dot ${cls}"></span><span class="mono">${pct(val)}</span></div>`;
}

function renderKpiTable(){
  const tbody = $("kpiTable");
  tbody.innerHTML = "";

  const rows = [
    ...QS.map(q => ({label:`${q}Q`, k: computeKPIFromCounts(getCountsForQuarter(q))})),
    {label:"åˆè¨ˆ", k: computeKPIFromCounts(getCountsTotal()), total:true}
  ];

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    if (r.total) tr.className = "totalRow";
    tr.innerHTML = `
      <td>${r.label}</td>
      <td>${kpiCell(r.k.half, targets.half)}</td>
      <td>${kpiCell(r.k.early, targets.early)}</td>
      <td>${kpiCell(r.k.paint, targets.paint)}</td>
      <td>${kpiCell(r.k.foul, targets.foul)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderScoreTableAndCorr(){
  const tbody = $("scoreTable");
  tbody.innerHTML = "";

  const xs = [];
  const ys = [];

  QS.forEach(q=>{
    const s = state.scores[q] || {us:null, them:null};
    const k = computeKPIFromCounts(getCountsForQuarter(q));
    const paint = k.paint;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${q}Q</td>
      <td><input class="scoreInput mono" type="number" inputmode="numeric" min="0" id="us_${q}" placeholder="-" /></td>
      <td><input class="scoreInput mono" type="number" inputmode="numeric" min="0" id="them_${q}" placeholder="-" /></td>
      <td class="mono">${pct(paint)}</td>
    `;
    tbody.appendChild(tr);

    const usEl = tr.querySelector(`#us_${q}`);
    const thEl = tr.querySelector(`#them_${q}`);
    usEl.value = (s.us ?? "");
    thEl.value = (s.them ?? "");

    const onChange = () => {
      const us = usEl.value === "" ? null : Number(usEl.value);
      const them = thEl.value === "" ? null : Number(thEl.value);
      state.scores[q] = {
        us: Number.isFinite(us) ? us : null,
        them: Number.isFinite(them) ? them : null
      };
      upsertState(true);
      renderScoreTableAndCorr();
    };
    usEl.addEventListener("change", onChange);
    thEl.addEventListener("change", onChange);
    usEl.addEventListener("blur", onChange);
    thEl.addEventListener("blur", onChange);

    if (s.us != null && Number.isFinite(s.us) && isFinite(paint)){
      xs.push(paint);
      ys.push(s.us);
    }
  });

  const sumUs = QS.reduce((acc,q)=> acc + (Number.isFinite(state.scores[q]?.us) ? state.scores[q].us : 0), 0);
  const sumThem = QS.reduce((acc,q)=> acc + (Number.isFinite(state.scores[q]?.them) ? state.scores[q].them : 0), 0);
  const trT = document.createElement("tr");
  trT.className = "totalRow";
  trT.innerHTML = `<td>åˆè¨ˆ</td><td class="mono">${sumUs}</td><td class="mono">${sumThem}</td><td class="mono">-</td>`;
  tbody.appendChild(trT);

  const r = pearson(xs, ys);
  const corrEl = $("corrVal");
  const noteEl = $("corrNote");
  if (r == null){
    corrEl.textContent = "-";
    noteEl.textContent = "ï¼ˆå¾—ç‚¹ã‚’2Qä»¥ä¸Šå…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤ºï¼‰";
  } else {
    const rr = Math.round(r*100)/100;
    corrEl.textContent = rr.toFixed(2);
    const abs = Math.abs(rr);
    let txt = "ï¼ˆå¼±ã„ï¼‰";
    if (abs >= 0.7) txt = "ï¼ˆå¼·ã„ï¼‰";
    else if (abs >= 0.4) txt = "ï¼ˆä¸­ãã‚‰ã„ï¼‰";
    noteEl.textContent = ` ${txt}  ${rr>0 ? "æ­£ã®ç›¸é–¢" : "è² ã®ç›¸é–¢"}`;
  }
}

function render(){
  $("opponent").value = state.opponent || "";
  $("gameDate").value = state.date || "";
  $("memo").value = state.memo || "";

  renderTotals();
  renderCountsTable();
  renderKpiTable();
  renderScoreTableAndCorr();
  renderGameSelect();
}

// =====================
// Wiring
// =====================
$("btnMenu").addEventListener("click", ()=> toggleMenu());
$("btnQuickSave").addEventListener("click", ()=> upsertState(false));

$("btnH").addEventListener("click", ()=> inc("H"));
$("btnB").addEventListener("click", ()=> inc("B"));
$("btnD").addEventListener("click", ()=> inc("D"));
$("btnT").addEventListener("click", ()=> inc("T"));
$("btnTP").addEventListener("click", ()=> inc("TP"));
$("btnUndo").addEventListener("click", undo);

$("gameSelect").addEventListener("change", (e)=> switchGame(e.target.value));

$("btnNewGame").addEventListener("click", newGame);
$("btnDeleteGame").addEventListener("click", deleteCurrentGame);
$("btnExportFile").addEventListener("click", exportAsFile);

$("btnImport").addEventListener("click", ()=> $("fileInput").click());
$("fileInput").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if (f) importFromFile(f);
  e.target.value = "";
});

$("btnTargets").addEventListener("click", openTargets);
$("btnTargetsCancel").addEventListener("click", closeTargets);
$("btnTargetsSave").addEventListener("click", saveTargetsFromUI);
$("btnTargetsDefault").addEventListener("click", resetTargetsDefault);
$("targetsModal").addEventListener("click", (e)=>{ if(e.target.id==="targetsModal") closeTargets(); });

["opponent","gameDate","memo"].forEach(id=>{
  $(id).addEventListener("change", ()=> upsertState(true));
  $(id).addEventListener("blur", ()=> upsertState(true));
});
$("quarter").addEventListener("change", ()=> upsertState(true));

$("btnImport").addEventListener("click", ()=> $("fileInput").click());

// =====================
// Init
// =====================
renderQuarterSelect();
if (!games.length){
  games = [state];
  saveGames(games);
} else {
  state = games[0];
  ensureKeys(state);
}
render();
toggleMenu(false);
toast("æ›´æ–°ç‰ˆã‚’èµ·å‹•ã—ã¾ã—ãŸ");
</script>
</body>
</html>
